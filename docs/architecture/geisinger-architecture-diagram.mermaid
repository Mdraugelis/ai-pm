graph TB
    subgraph External["ğŸŒ External Systems & Users"]
        USER[ğŸ‘¤ Human Users]
        EXT_SYS[ğŸ¢ Enterprise Systems<br/>EHR, Legal, HR, PM Tools]
    end

    subgraph MetaLayer["ğŸ“‹ LAYER 8: Meta-Blueprint Constitution"]
        META[ğŸ›¡ï¸ Universal Agent Principles<br/>â€¢ Safety First<br/>â€¢ Transparency<br/>â€¢ Privacy & Compliance<br/>â€¢ Ethical Guidelines<br/>ALWAYS LOADED]
    end

    subgraph AgentCore["ğŸ¤– AGENT CORE SYSTEM"]
        
        subgraph Layer1["âš™ï¸ LAYER 1: Core Agent Orchestration Engine"]
            LOOP{{"ğŸ”„ Agent Loop"}}
            GATHER[1ï¸âƒ£ Gather Context]
            PLAN[2ï¸âƒ£ Plan Action]
            ACT[3ï¸âƒ£ Execute Tools]
            VERIFY[4ï¸âƒ£ Self-Verify]
            ITERATE[5ï¸âƒ£ Iterate/Adapt]
            
            LOOP --> GATHER
            GATHER --> PLAN
            PLAN --> ACT
            ACT --> VERIFY
            VERIFY --> ITERATE
            ITERATE -->|Not Complete| GATHER
            ITERATE -->|Complete| HITL
        end

        subgraph Layer2["ğŸ’¾ LAYER 2: Memory & Context Management"]
            WORK_MEM[ğŸ“ Working Memory<br/>50K tokens]
            LONG_MEM[ğŸ—„ï¸ Long-Term Memory<br/>Persistent State]
            CONTEXT[âš–ï¸ Context Budget Manager<br/>200K total / 12K always-loaded]
            COMPACT[ğŸ—œï¸ Auto-Compaction<br/>When > 80% capacity]
        end

        subgraph Layer3["ğŸ”§ LAYER 3: Tool Use Framework"]
            TOOL_REG[ğŸ“š Tool Registry<br/>MCP-Based]
            TOOL_DISC[ğŸ” Tool Discovery]
            TOOL_EXEC[âš¡ Tool Execution]
            TOOL_VER[âœ… Tool Verifier]
        end

        subgraph Layer4["ğŸ‘ï¸ LAYER 4: Agent Perceptions"]
            PUSH[ğŸ“¨ Push: Events/Alerts]
            PULL[ğŸ” Pull: Queries/Retrieval]
        end

        subgraph Layer5["ğŸ’¬ LAYER 5: Agent Interactions"]
            CONV[ğŸ’­ Conversational UI]
            PROACT[ğŸ’¡ Proactive Recommendations]
            EXPLAIN[ğŸ“Š Explainability]
        end

        subgraph Layer7["ğŸ§  LAYER 7: Strategic Knowledge (BluePrints)"]
            BP_CLINICAL[ğŸ¥ Clinical BluePrints]
            BP_LEGAL[âš–ï¸ Legal BluePrints]
            BP_PRODUCT[ğŸ“¦ Product BluePrints]
            BP_CUSTOM[ğŸ¯ Custom Domain BluePrints]
        end

        subgraph Layer6["ğŸ“– LAYER 6: Domain Knowledge Base"]
            POLICIES[ğŸ“œ Policies]
            GUIDELINES[ğŸ“‹ Guidelines]
            PROCEDURES[ğŸ”„ Procedures]
            EXAMPLES[ğŸ’¡ Examples]
        end
    end

    subgraph MCPLayer["ğŸ”Œ MCP Integration Layer"]
        MCP_CLIENT[ğŸ”Œ MCP Client<br/>Agent Side]
        MCP_SERVERS[ğŸ–¥ï¸ MCP Servers<br/>â€¢ EHR Server<br/>â€¢ Legal DB Server<br/>â€¢ JIRA Server<br/>â€¢ SharePoint Server<br/>â€¢ Custom Connectors]
    end

    subgraph Layer9["ğŸ‘¥ LAYER 9: Human-in-the-Loop"]
        HITL{{"ğŸš¦ Self-Verification<br/>Passed?"}}
        TIER1[âœ… Tier 1: No Review<br/>Auto-Proceed]
        TIER2[ğŸ‘€ Tier 2: Passive<br/>Audit Later]
        TIER3[âœ‹ Tier 3: Active<br/>Approval Required]
        TIER4[ğŸš¨ Tier 4: Critical<br/>Immediate Escalation]
        
        HITL -->|Yes, Low Risk| TIER1
        HITL -->|Yes, Medium Risk| TIER2
        HITL -->|Yes, High Risk| TIER3
        HITL -->|No/Critical| TIER4
    end

    subgraph Layer10["ğŸ›¡ï¸ LAYER 10: Guardrails & Safety"]
        SAFETY_INPUT[ğŸ”’ Input Validation]
        SAFETY_EXEC[ğŸ‘® Execution Monitoring]
        SAFETY_OUTPUT[ğŸ” Output Validation]
        PROMPT_DEF[ğŸ›¡ï¸ Prompt Injection Defense]
        AUDIT[ğŸ“ Audit Trail]
    end

    subgraph Layer11["ğŸ“Š LAYER 11: Evaluation & Observability"]
        GOLDEN[ğŸ† Golden Tests]
        SAFETY_TEST[ğŸ§ª Safety Test Suite]
        REGRESSION[ğŸ”„ Regression Tests]
        PERF[âš¡ Performance Benchmarks]
        REDTEAM[ğŸ¯ Red Team Testing]
        SHADOW[ğŸ‘¥ Shadow Testing]
        METRICS[ğŸ“ˆ Metrics Dashboard]
    end

    subgraph CrossCutting["âš¡ Cross-Cutting Concerns"]
        RBAC[ğŸ” RBAC & Permissions]
        CONSENT[ğŸ“‹ Per-Call Consent]
        ENCRYPTION[ğŸ”’ Encryption & PHI Protection]
        VERSION[ğŸ“Œ Version Control]
    end

    %% User Interactions
    USER -->|Request| CONV
    CONV -->|Response| USER
    
    %% Meta-Blueprint Always Loaded
    META -.->|Governs All| LOOP
    
    %% Agent Loop Connections
    PLAN -->|Consults| Layer7
    PLAN -->|Consults| Layer6
    GATHER -->|Reads| WORK_MEM
    GATHER -->|Reads| LONG_MEM
    GATHER -->|Uses| Layer4
    ACT -->|Invokes| Layer3
    VERIFY -->|Checks Against| META
    ITERATE -->|Updates| WORK_MEM
    
    %% Memory Management
    WORK_MEM -->|Trigger| COMPACT
    COMPACT -->|Summarize to| LONG_MEM
    CONTEXT -->|Manages| WORK_MEM
    
    %% Tool Execution Flow
    TOOL_EXEC -->|Calls| MCP_CLIENT
    MCP_CLIENT -->|Protocol| MCP_SERVERS
    MCP_SERVERS -->|Connect to| EXT_SYS
    TOOL_DISC -->|Reads| TOOL_REG
    TOOL_EXEC -->|Post-Check| TOOL_VER
    
    %% Perceptions
    EXT_SYS -->|Events| PUSH
    PULL -->|Queries| MCP_CLIENT
    PUSH -->|Alerts| GATHER
    PULL -->|Data| GATHER
    
    %% Interactions
    CONV -->|Initiates| LOOP
    PROACT -->|From| LOOP
    EXPLAIN -->|Traces| AUDIT
    
    %% HITL Flow
    TIER1 -->|Execute| ACT
    TIER2 -->|Execute + Log| ACT
    TIER3 -->|Wait for Approval| USER
    TIER4 -->|Escalate to| USER
    USER -->|Approval| ACT
    
    %% Safety Layer
    CONV -->|Validate| SAFETY_INPUT
    SAFETY_INPUT -->|Clean Input| LOOP
    ACT -->|Monitor| SAFETY_EXEC
    VERIFY -->|Final Check| SAFETY_OUTPUT
    Layer3 -->|Defend| PROMPT_DEF
    LOOP -.->|Log All| AUDIT
    
    %% Evaluation
    LOOP -.->|Measure| METRICS
    Layer3 -.->|Test| GOLDEN
    SAFETY_INPUT -.->|Test| SAFETY_TEST
    LOOP -.->|Test| REGRESSION
    ACT -.->|Benchmark| PERF
    LOOP -.->|Attack| REDTEAM
    LOOP -.->|Mirror| SHADOW
    
    %% Cross-Cutting
    RBAC -.->|Control| Layer3
    CONSENT -.->|Authorize| ACT
    ENCRYPTION -.->|Protect| WORK_MEM
    ENCRYPTION -.->|Protect| MCP_CLIENT
    VERSION -.->|Track| Layer7

    classDef metaStyle fill:#ff6b6b,stroke:#c92a2a,stroke-width:3px,color:#fff
    classDef coreStyle fill:#4dabf7,stroke:#1971c2,stroke-width:2px,color:#fff
    classDef memStyle fill:#51cf66,stroke:#2f9e44,stroke-width:2px,color:#fff
    classDef toolStyle fill:#ffd43b,stroke:#f59f00,stroke-width:2px,color:#000
    classDef perceptionStyle fill:#ff8787,stroke:#fa5252,stroke-width:2px,color:#fff
    classDef knowledgeStyle fill:#b197fc,stroke:#7950f2,stroke-width:2px,color:#fff
    classDef hitlStyle fill:#ffa94d,stroke:#fd7e14,stroke-width:2px,color:#000
    classDef safetyStyle fill:#e599f7,stroke:#ae3ec9,stroke-width:2px,color:#fff
    classDef evalStyle fill:#74c0fc,stroke:#1c7ed6,stroke-width:2px,color:#fff
    
    class META metaStyle
    class LOOP,GATHER,PLAN,ACT,VERIFY,ITERATE coreStyle
    class WORK_MEM,LONG_MEM,CONTEXT,COMPACT memStyle
    class TOOL_REG,TOOL_DISC,TOOL_EXEC,TOOL_VER toolStyle
    class PUSH,PULL perceptionStyle
    class BP_CLINICAL,BP_LEGAL,BP_PRODUCT,BP_CUSTOM,POLICIES,GUIDELINES,PROCEDURES,EXAMPLES knowledgeStyle
    class HITL,TIER1,TIER2,TIER3,TIER4 hitlStyle
    class SAFETY_INPUT,SAFETY_EXEC,SAFETY_OUTPUT,PROMPT_DEF,AUDIT safetyStyle
    class GOLDEN,SAFETY_TEST,REGRESSION,PERF,REDTEAM,SHADOW,METRICS evalStyle
